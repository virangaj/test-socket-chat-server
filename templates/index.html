<!DOCTYPE html>
<html>
  <head>
    <title>WebSocket Chat Client</title>
  </head>
  <body>
    <h1>WebSocket Chat Client</h1>
    <input type="text" id="messageInput" placeholder="Enter message" />
    <button onclick="sendMessage()">Send Message</button>
    <div id="messages"></div>

    <script>
      let socket;
      let reconnectAttempts = 0;

      function initializeWebSocket() {
        socket = new WebSocket("ws://localhost:3001");

        // Connection opened
        socket.addEventListener("open", (event) => {
          console.log("Connected to WebSocket server");
          reconnectAttempts = 0; // Reset the reconnect attempts on successful connection
          // Example of joining a room
          socket.send(
            JSON.stringify({
              event: "joinRoom",
              data: {
                payperviewId: 64,
                token: "1635|3hGrVlFzy5LNfvufRdZlATjkgk6r9ERWduCkLXDd",
              },
            })
          );
        });

        // Listen for messages
        socket.addEventListener("message", (event) => {
          console.log(event);
          const receivedMessage = JSON.parse(event.data);
          console.log("Message from server:", receivedMessage);
          displayMessage(receivedMessage);
        });

        // Error handling
        socket.addEventListener("error", (event) => {
          console.error("WebSocket error:", event);
        });

        // Connection closed
        socket.addEventListener("close", (event) => {
          console.log("WebSocket connection closed:", event);
          attemptReconnect();
        });
      }

      function attemptReconnect() {
        const timeout = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000); // Exponential backoff
        setTimeout(() => {
          console.log(`Reconnecting attempt #${reconnectAttempts + 1}`);
          reconnectAttempts++;
          initializeWebSocket();
        }, timeout);
      }

      function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value;

        if (message && socket.readyState === WebSocket.OPEN) {
          socket.send(
            JSON.stringify({
              event: "send-message",
              data: {
                payperviewId: 64,
                message: message,
                token: "1635|3hGrVlFzy5LNfvufRdZlATjkgk6r9ERWduCkLXDd",
              },
            })
          );
          messageInput.value = "";
        } else {
          console.error("WebSocket is not open. Message not sent.");
        }
      }

      function displayMessage(message) {
        const messagesDiv = document.getElementById("messages");
        const messageElement = document.createElement("div");

        messageElement.textContent = JSON.stringify(message);
        messagesDiv.appendChild(messageElement);
      }

      // Initialize WebSocket connection when the page loads
      window.addEventListener("load", () => {
        initializeWebSocket();
      });
    </script>
  </body>
</html>
